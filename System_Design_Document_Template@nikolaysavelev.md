# System Design Document
## Дизайн системы <i>название системы</i>
    
> ### Глоссарий
> В этом разеделе требуется определить термины и дать им определения. Читатель вашего SDD не всегда понимает, о чем идет речь. Особенно, если много аббревиатур.
> | Термин  | Определение |
> | ------------- | ------------- |
> | System Design  |  Процесс проектирования систем с учетом всех их компонентов и взаимодействий  |
> | System Design Interview  | Этап собеседования, на котором оценивается умение проектировать сложные системы  |

---

### 1. Цели и предпосылки (Отсев + Scope Refinement)

<details>
<summary><strong>ℹ️ Как заполнять раздел?</strong></summary>

- Используйте этот раздел для ответа на вопросы: правильно ли я понимаю своего партнера и адекватен ли он в своих намерениях.
- Не стоит уходить в детали, стремитесь к лаконичности.
- Если на какие-то вопросы ответ дается с трудом или не дается вовсе, стоит задуматься и уточнить у коллег - а надо ли бежать делать систему.
</details>

#### 1.1. Заполните контрольные вопросы

- Какая цель у стейкхолдеров?
> Повысить выручку на N% путем автоматизации процесса продажи автомобилей.
- Какую проблему решает система?
> Бизнес-процесс продажи автомобилей не автоматизирован, бизнес говорит, что операционные расходы высокие.
- Какой результат будем считать успехом?
> Требуется определить бизнесовые критерии приемки. Данный пункт нужен, чтобы на берегу договориться об ожиданиях с бизнесом.
- Как будем измерять результат?
> Сформировать метрики определения успешности (в зависимости от системы и ситуации могут быть разными). Определить, как будем измерять результат (A/B тесты, аналитика, отчеты, фидбек юзеров).
- Для кого создается система и какие боли закрываем?
> Для покупателей автомобилей. Закрытие болей стрясти с бизнеса: CJM и т.д.
- Что будет, если мы не сделаем систему? 
> Опционально, здесь можно написать про риски.
- Что если сорвем сроки?
> Определяем потенциальные последствия.
- Какие есть зависимости?
> Определяем на что зависим, что может нас заблокировать. Есть ли внешние системы или команды или неочевидные обстоятельства, без которых реализация невозможна.


#### 1.2. Бизнес-требования 

- Краткое описание бизнес-требований. Задел для детальных ФТ/НФТ.
> Здесь БТ
- Описание бизнесовых ограничений.
> Здесь бизнес-ограничения, например, сроки и бюджет
- (опционально) BPMN-диаграмма.


#### 1.3. Скоуп проекта  (Scope Refinement)
Особенно важный пункт во время интервью. Если просят спроектировать большую систему (Facebook, Tinder, etc): следует взять в скоуп не более 5 основных функций, иначе можно закопаться.

- На закрытие каких БТ подписываемся. 
- На закрытие каких БТ не подписываемся.
- Приоритеты.
- Краткая выжимка того, что хотим сделать.


### 2. Требования и ограничения
<details> <summary><strong>ℹ️ Как работать с разделом?</strong></summary>

- ФТ — описываем, что делает система.
- НФТ — описываем, как она это делает (производительность, надежность и т.д.).
- Расчет нагрузки — "на салфетке" означает оценку порядка величин без углубления в детали.

</details>

#### 2.1 Функциональные требования (ФТ)
В качестве удобного формата представления предлагаю использовать таблицу.

На интервью мы хотим раскрутить собеседующего, чтобы он ответил на вопросы:
1. Какие есть акторы? (участники процессов)
2. Какой у нас домен? Какие данные, какие бизнес-процессы?
3. Какие основные функции должна выполнять система?
4. Есть ли специфические сценарии использования?
5. Ключевые точки:
    - Приоритизация функций (понять, что будем делать в MVP и что core нашего приложения)
    - Какие есть корнер-кейсы, для которых нужны дополнительные ФТ

В процессе ответа на вопросы можно фиксировать ФТ.

Способы фиксации: User Story, JTBD, Use Case

| ID  | User Story | Приоритет | Источник (БТ) |
| ------------- | ------------- | ------| -----|
| FT1  |  Я как пользователь хочу регистрироваться на сайте через номер телефона  | Highest | BT1 |
| FT2  | Я как администратор системы хочу уметь сбросить пароль пользователю  | Medium | BT3 |

#### 2.2 Нефункциональные требования (НФТ)
В качестве удобного формата представления предлагаю использовать таблицу.

| ID  | Категория | Требование | Приоритет | Источник (БТ) |
| ------------- | ------------- | ------| -----| ---- |
| NFT1  |  Безопасность | Аутентификация через OAuth2.0  | High | BT1 |
| NFT2  | Производительность | Латенси меньше 500 мс 95 перцентиль |  Highest | BT3 |

Стандартные категории для самопроверки:
1. Производительность (профиль нагрузки: стандарт/пики) - пропускная способность
2. Масштабируемость
3. Отказоустойчивость
4. Безопасность
5. Observability: мониторинг, логирование, трейсинг
6. Регуляторные требования
7. Переносимость и совместимость системы
8. Пользовательский опыт (UX)

#### 2.3 Расчет нагрузки
В этом разделе нам важно понять порядки (как на интервью, так и при проектировании реальных систем).

Требуется намайнить как можно больше вводных, которые помогут точнее рассчитать нагрузку.

Хотим прогнозировать сколько денег потратим на инфру и какие компоненты нам нужны.
1. Пользовательский трафик, сценарии использования, количество RPS
2. Сетевой трафик и соединения
3. Нагрузка на вычислительную мощность
4. Необходимое дисковое пространство для хранения данных и расчет
потенциального прироста объема хранилища 

Ниже представлены факты, которые помогут посчитать нагрузку.

*ТРАФИК*
1. В сутках 86 400 секунд.
2. DAU обычно 10-30% от MAU.
3. Пиковый час: 10-20% от всего суточного трафика.
4. Нужно учитывать сезонность и пользователей системы: Black Friday, праздники, рабочие дни.
5. RPS = (DAU * Среднее кол-во действий в день * Пиковый коэффициент) / 86 400.
6. Пиковый коэффициент - берем из логических рассуждений. Во сколько раз трафик может пикануть максимум - сколько мы закладываем для надежности (например, в 2 раза).

*ДАННЫЕ*
1. Средний размер HTTP-запроса с форматом JSON: 1 KB (= 1024 B).
2. Изображение: размер сильно отличается. Но в среднем 10-1000 KB.
3. Видео (можно записать себе сколько секунда видео в 720p и 1080p): 1-10 MB.
4. Не забываем про реплики и бэкапы.

*БД*
1. Отношение чтение/запись:
    - Для систем с множеством контента: 80/20
    - Для стандартных систем: 60/40
    - IoT: 30/70
2. Лимиты БД:
    - SQL: ~500-1000 QPS на инстанс
    - NoSQL: 10k-100k QPS на инстанс

*СРОКИ ХРАНЕНИЯ ДЛЯ БОЛЬШИНСТВА СИСТЕМ*
1. Горячие данные (Hot Storage): 1-7 дней
2. Теплые данные (Warm Storage): 1-12 месяцев
3. Холодные данные (Cold Storage): более года


*СКОРОСТЬ РАБОТЫ ХРАНИТЕЛЕЙ*
1. SSD: 10k-100k IOPS
2. HDD: 100-200 IOPS
3. RAM: 1M+ IOPS

*СЕТЬ*
1. 1 Gbit/s = 125 MB/s
2. Задержка внутри датацентра: 0.1-1 мс
3. Задержка между континентами: 100-300 мс

*ПОЛЕЗНЫЕ ПРИБЛИЖЕНИЯ*
1. В 1 GB: ~1 миллион JSON-объектов
2. В 1 TB: ~250 миллионов страниц текста
3. 1 сервер (8 ядер): 5k-50k RPS в зависимости от сложности запросов


#### 2.4 Ограничения

В этом разделе требуется:
1. Пройти по чек-листу ограничений и уточнить, что применимо к текущему кейсу
2. Сформулировать вместе со стейкхолдером или собеседующим их список
3. Сделать выводы из ограничений

##### Пример
> Делаем продукт в РФ (1) в 2025 году (2), бизнес-модель B2C (3), целимся в Android-разработку (4), хотим быстрый релизный цикл (5) и высокую доступность (6), чтобы захватить рынок. Целевая метрика Retention (7).

**Выводы**
1. Потенциальные интеграции с РФ IT-ландшафтом. Используем российские облака (Yandex Cloud/SberCloud), готовим санкционные резервные планы (например, переход на open-source аналоги). Помним про регуляторные требования.
2. Учитываем импортозамещение (отказ от зарубежных сервисов, где есть риски), фокус на кроссплатформенные решения с оглядкой на возможные изменения законодательства.
3. Оптимизируем под масштабируемость, быстрые релизы (CI/CD), A/B-тестирование для роста Retention. (за подробностями см. таблицу ниже)
4. Нужны разработчики BE-части и мобильные разработчики. Т.к. Android, надо искать Kotlin-разработчиков. Нужно закладывать ресурсы на тестирование под мобилку (устройства или эмуляторы).
5. Kubernetes + ArgoCD для деплоя, Feature Flags, Canary-Deployment, автоматические rollback при падении.
6. МультиЦОД, дополнительное резервирование (кластеризация для отказоустойчивости), мониторинг через Prometheus/Grafana, SLA 99.95%.
7. Персонализация через рекомендательные системы, A/B-тесты, аналитика в ClickHouse.

##### 2.4.1 Список ограничений (может дополняться)
1. Бизнес-модель
2. Основные бизнес-метрики и масштабирование: DAU/MAU, Retention, ROI
3. География пользователей: город, страна, мир
4. Специфика домена: екоммерс, финтех, кибербез
5. Тип устройств: мобилка, десктоп, браузер
6. Этап развития: MVP / Full-Scale Product
7. Тип развертывания: Cloud / On-Premise
8. Время разработки
9. Бюджет на технологии
10. Технологии: тех. компас компании, переиспользование
11. Существующие сервисы
12. Бюджет на железо
13. SLA: доступность, производительность
14. Регуляторные: юридические нормы
15. Интеграции
16. Санкции и импортозамещение

##### 2.4.2 Сравнения бизнес-модель: B2B / B2C / B2G

| Характеристика       | B2B                          | B2C                          | B2G                          |
|----------------------|------------------------------|------------------------------|------------------------------|
| **Пользователи**     | Сотрудники компаний (сотни-тысячи), менее требовательны к UX | Массовая аудитория (тысячи-миллионы), высокие требования к UX | Госслужащие, строгая регламентация |
| **Интеграции**       | ERP (SAP, 1C), CRM, ЭДО, [Active Directory/Keycloak](https://habr.com/ru/companies/rshb/articles/724508/) | CRM, Платежные системы (а ля Stripe), соцсети, email-сервисы, телефония, SSO | Госсистемы (ЕСИА - Госуслуги, ГИС ЖКХ), ЭЦП, СМЭВ (Сервис межведомственных взаимодействий) |
| **Безопасность**     | Антивирус, Корпоративные DLP и SIEM, опционально требования ФСТЭК | Защита ПДн (152-ФЗ), антифрод, SSO, Anti-DDoS, WAF. Больше внимания на эксплуатацию угроз типа инъекций, брутфорса, DDoS. | ФСТЭК/ФСБ сертификация, ГОСТ Р 57580 |
| **Кастомизация**     | White-label, модули под клиента ([Feature Flags](https://habr.com/ru/articles/543420/)) | Персонализация контента (но не всего приложения), A/B тесты | Поддержка законодательных норм |
| **Релизный цикл**   | Чаще всего не очень быстрый из-за больших бизнес-фичей. Требуется обучение сотрудников бизнеса. CI/CD может быть не сильно развит |  В большинстве случаев частые релизы. Сложный CI/CD | Опционально, но чаще всего система поставляется целиком, методология разработки скорее Waterfall, сложный CI/CD не нужен
| **Аналитика**        | Обычно требуются модули аналитики и отчетности: потенциально, интеграции с [BI-системами](https://www.unisender.com/ru/glossary/business-intelligence/#anchor-2), всяческие [ETL-процессы](https://habr.com/ru/articles/248231/) | Юзабилити-метрики, воронки конверсии, обязательно стоит упомянуть про Пользовательскую (Клиентскую) аналитику, например, Яндекс.Метрика или Google Analytics | Регламентированная отчетность в госорганы, потенциально нужна будет кастомные модули под такую аналитику |
| **Развертывание**    | Cloud (будет плюсом, если разговор зайдет про [мультитенантность](https://habr.com/ru/articles/542678/)) или может быть On-Premise: на серверах компании. Подробнее [плюсы и минусы](https://habr.com/ru/companies/otus/articles/831564/) | Облако (99.9% uptime), Serverless | Только On-Premise или отечественные облака (SberCloud) или может быть Private Cloud |
| **Архитектурные акценты** | Модульность, адаптеры для legacy-систем | Масштабируемость, кэширование | Аудит логов, неизменяемость данных |
| **География** | Зависит от компании, но чаще всего ограничение в одно государство, менее чувствителен к CDN | Весь мир, нужно учитывать CDN и распределенные дата-центры | Государство |
| **Тип устройства** | Чаще всего это рабочие места сотрудников (ноутбуки). Может быть специальная аппаратная часть, например, банкоматы или расчетные терминалы. Могут быть требования под специфическую версию браузера. Значит, Desktop или Web-приложение | Mobile (PWA или просто приложение на Android/IOS), Desktop (например, телеграм или спотифай), Web (наиболее популярное) | Чаще всего Desktop, может быть Web. Могут быть требования под специфическую версию браузера |
| **Примеры**          | Корпоративный портал SAP, HR-системы | Маркетплейсы, соцсети | Портал госуслуг, налоговые системы |


### 3. Проектирование
<details>
<summary><strong>ℹ️ Как заполнять раздел?</strong></summary>

- На интервью в Excalidraw / DrawIO
- В реальности заполняем каждый раздел этого документа
- Углубляемся в детали и компромиссы
- Рисуем схемы, даем больше графики богу графики
</details>

#### 3.1 High Level Design
##### 3.1.1 Интеграции

Проектируем публичное API для системы.

Зачем начинать с интеграций?
1. Более явно фиксируем scope — предотвращаем "расползание" функционала
2. Выявляем доп. сущности — пользователи, ресурсы, отношения
3. Определяем ограничения, которые не смогли определить ранее — RPS, размеры данных, форматы
4. Стандарт для команды — фронтенд/бэкенд/мобильные разработчики работают по единому контракту

**Для интервью**
1. При сборе ФТ определили:
    - Сущности (акторы, артефакты домена)
    - Операции над сущностями (CRUD и что-то большее)
2. Выбираем тип интеграции: синхронная или асинхронная, даем обоснование
3. Выбираем внутренний подход: REST, RPC, SOAP, etc
4. Пилим несколько ручек, например:
    - `POST /trips` (создать поход)  
    - `GET /trips/{id}/map` (загрузить карту)  
    - `PUT /sync` (синхронизировать офлайн-данные)  
5. Накидываем возможные request / response
6. Подвязываем НФТ (например, Rate Limiter)

**Для реальных кейсов**
1. Все то же, что и для интервью
2. Расписываем контракты в OpenAPI / AsyncAPI формате

##### 3.1.2 Данные

Определяем статический и динамический вид данных.

- Статический: Entity Relationship диаграмма, концептуальное наполнение БД. Что храним. **Цель**: показать структуру данных, их связи, индексы. 
- Динамический: Data Flow диаграмма. Как передаем хранимое по системе. **Цель**: показать, как данные перемещаются между компонентами системы.

**Для интервью**
1. Статический вид
    - Определяем таблицы и поля в них (типы, constraints)
    - Говорим про нормализацию и денормализацию, про потенциальные компромиссы
    - Говорим про связи (1:M, M:M)
    - Говорим про очевидные индексы
2. Динамический вид
    - Описываем источники данных (пользователь, устройства, внешние системы: де-факто все акторы из C4 context level)
    - Описываем потоки (направление, формат, объем)
    - Описываем обработчики (сервисы, брокеры, БД)

**Для реальных кейсов**

Все то же самое, только расширяем "что" и "как" описываем.

Например, используем не только Context level C4, но и Container level. 
Последовательность действий описываем в Sequence-диаграмме, много говорим о edge-кейсах.

##### 3.1.3 Концептуальная схема
К этому моменту определили:
1. Основные сценарии
2. Акторов
3. Интеграции
4. БД

Для составления концептуальной схемы остается лишь выделить компоненты-сервисы.

**Принципы декомпозиции**

0. Стараемся не делать мегасервис, но и не делать наносервис на 1-2 метода. Важно выдержать баланс. Если монолит оправдан, делаем монолит. На интервью редко когда он оправдан.
1. Domain-Driven Design (DDD)
    - Сервис имеет ограниченный контекст (четкие границы). Сущности и операции над ними определили выше. Не составит труда выделить отдельные сервисы на основе этих фактов.
    - Чаще всего отлично подходит на интервью.
2. Принцип единственной ответственности (Single Responsibility)
    - Сервис имеет одну зону ответственности.
3. Принцип независимого развертывания
    - Тут больше про отсутствие зависимостей и агрегацию единого бизнес-смысла в сервисе.
4. Масштабируемость
    - Стоит выносить в отдельный сервис высоконагруженные компоненты, которые потенциально будем горизонтально масштабировать

После определения сервисов делаем набросок концептуальной архитектуры.

На интервью лучше квадраты-стрелки в Excalidraw.

В реальности лучше набросать в [**Нотации С4**](https://habr.com/ru/articles/778726/).

#### 3.2 Deep Dive

На данном этапе расширяем систему архитектурными и программными подходами, чтобы решить определенные проблемы и достичь выполнения всех ФТ, НФТ и учесть ограничения.

Для дальнейшей формализации на реальных кейсах можно описывать детально таблицу: в какую проблему погружаемся, какие есть способы решения, какие технологии и подходы.

В качестве плана раздела:
1. Обсудить ключевые компоненты и их назначение
2. Погрузиться в отдельную проблему (с подачи интервьюера или самостоятельно инициировав) и рассмотреть ее глубже
3. Поговорить про дополнительную обвязку
4. Поговорить про важные компромиссы с бизнесом
5. Поговорить про установку системы, про релизные циклы
6. Поговорить про то, кто все это будет делать (команды) и за счет каких ресурсов (TCO, риски)
7. Если останется время, поговорить про более отвлеченные, но важные вещи. Про то, как будем делать нагрузочное тестирование, как интерпретировать результаты, как будем восстаналивать компоненты при отказах

**Важно**

> На интервью на данном этапе собеседующий будет углубляться в конкретные компоненты или механизмы. Часто это что-то из вашей предметки. 

> Например, для DevOps-инженеров разговор зайдет о способах развертывания, выборе CI/CD подхода, механизмах управления секретами, Service Mesh. Для Backend-разработчиках об алгоритмике определенных компонентов, методах кэширования, индексирования БД.

> Рекомендую до этого этапа на протяжении интервью расставлять крючки: упоминать темы, в которых вы отлично ориентируетесь. Вероятно, вас спросят именно о них.

##### 3.2.1 Ключевые компоненты/подходы и их назначение
|Компонент/подход	| Что это и решаемая проблема |	Ключевые моменты на подсветить |
----------| --------------- | ---------------------|
Балансировщик нагрузки (Load Balancer / LB) |	Устройство или программное решение, которое распределяет сетевой трафик между несколькими серверами, чтобы избежать перегрузки одного из них и обеспечить высокую доступность и производительность системы | Алгоритмы балансировки (Round Robin, Least Connections, IP Hash, другие); L4 (transport level) и L7 (application level) балансировщики; Программные и Аппаратные LB; Sticky session и Session Affinity; Service Discovery; High Availability (конфигурация Active-Active) |
CDN	| Сеть геораспределённых серверов, которые кэшируют и доставляют статический и иногда динамический контент ближе к пользователю, снижая задержки и нагрузку на основной сервер | Разгрузка Origin-серверов, Point of Presence, алгоритм работы CDN, типы хранимого контента, Edge-логика |
Кэш	| Быстрый, ограниченный по объёму слой хранения, предназначенный для временного сохранения часто используемых или дорого получаемых данных, чтобы ускорить доступ к ним | Типы кэширования, инвалидация кэша, вытеснение данных, косты оперативной памяти, inline и sidecar кэши, целесообразность кэширования, TTL
Репликация | Процесс копирования данных с одного узла (master/primary) на другие узлы (replicas/secondaries) для отказоустойчивости, масштабирования на чтение, обеспечения высокой доступности | Типы репликации (sync/async), топология репликации (master-slave, multimaster), подходы к репликации (WAL и др.), кворум (RAFT, Paxos), failover, проблемы и сложности: brain split, лаги, потеря данных |
Шардирование | Горизонтальное разбиение данных на независимые части (шарды), каждая из которых хранится и обрабатывается отдельно на разных узлах. Цель -  масштабирование пропускной способности | Отличие от репликации, отличие от партиционирования, тип шардирования, способы шардирования, ключ шардирования и подходы к его выбору, single и cross-shard запросы, балансировка и решардинг, проблемы и подводные камни шардирования + пути решения | 
IdP	| Сервис, который аутентифицирует пользователей, управляет их учетными записями, выпускает токены/ассертии для сторонних сервисов (SP — Service Provider). Нужен для централизованной аутентификации, единого входа (SSO), упрощённого и ЕДИНОГО управления доступом | Основные инструменты (например, Keycloak), основные протоколы (SAML, OIDC, OAuth 2.0), участники взаимодействия, потоки аутентификации, федерации, токены, управление пользователями |
Observability | Способность понять внутреннее состояние системы по её внешнему поведению (метрики, логи, трассировки, профили). Цель - быстро обнаружить, диагностировать и устранить проблемы в продакшене. Может пригодиться для НТ. | 3 (4) столпа наблюдаемости: метрики, логи, трейсы. Четвертый - профили. Стоит затронуть механизмы, алертинг, интеграции и стандарты (например, opentelemetry), ключевые best-practices, связь с DevOps и SRE (как использовать и как встраивать в процессы) |
| API Gateway      | Единая точка входа для всех внешних клиентов, проксирует и маршрутизирует запросы к микросервисам. Решает вопросы аутентификации, валидации, мониторинга, rate limiting, CORS и др. | Отличие от обычного прокси и LB, отличие от ESB (! важно), edge routing, circuit breakers, OpenAPI/Swagger, интеграция с IdP, инструменты (Kong, Tyk, nginx), observability и безопасность |
| Circuit Breaker, Retry, Rate Limiting | Механизмы отказоустойчивости и защиты от перегрузок | Circuit breaker (закрытие "сломанных" цепочек), Retries с backoff и jitter, Timeouts, Rate limiting (по IP, user, API key), инструменты (resilience4j, Istio, Envoy), метрики отказов |
| Service Mesh     | Инфраструктурный слой, обеспечивающий сетевое взаимодействие между сервисами (маршрутизация, безопасность, телеметрия) без изменения кода приложений | Sidecar-паттерн (например, Envoy), data plane vs control plane, observability из коробки, интеграция с OTel и IdP, mesh-инструменты (Istio, Linkerd, Consul Connect) |
| CI/CD            | Автоматизация сборки, тестирования, проверки качества и деплоя на тестовые среды и в прод. Снижает время выхода изменений, повышает стабильность, снижает риск человеческого фактора | GitOps-подход, blue/green и canary deployment, rollback, хелсчеки (readiness/liveness), инструменты (GitHub Actions, ArgoCD, Tekton, Spinnaker), security scanning и в целом Quality Gates (SAST, DAST + инструменты) |

#### 3.3 Итоговая архитектура решения

**На интервью**

Достаточно совмещенной из HLD и Deep Dive схемы + итогов словами.

**В реальности**

Должна быть выжимка из пунктов выше, чтобы был цельный кусок архитектуры системы, встраиваемый в корпоративную архитектуру. Иногда может быть похожим на [ADR - Architecture Decision Record](https://github.com/joelparkerhenderson/architecture-decision-record?tab=readme-ov-file)